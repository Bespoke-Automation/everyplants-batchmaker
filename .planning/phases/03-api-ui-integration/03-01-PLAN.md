---
phase: 03-api-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/verpakking/VerpakkingsClient.tsx
autonomous: false
requirements:
  - API-01
  - UI-01

must_haves:
  truths:
    - "Medewerker ziet per geadviseerde doos de dooskosten, transportkosten en totaalkosten in het advies-panel"
    - "Medewerker ziet totale kosten in de ingeklapte advies-banner als samenvatting"
    - "Medewerker ziet kosten per doos in de doos-selectie knoppen bij het toevoegen van een doos"
    - "Wanneer kostdata niet beschikbaar was, toont de UI een amber waarschuwing"
    - "VerpakkingsClient stuurt automatisch het bestemmingsland mee bij engine berekening"
    - "POST /api/verpakking/engine/calculate valideert countryCode tegen bekende landcodes"
  artifacts:
    - path: "src/components/verpakking/VerpakkingsClient.tsx"
      provides: "Cost display in advice banner, box selection, and cost-unavailable warning"
      contains: "box_cost"
    - path: "src/app/api/verpakking/engine/calculate/route.ts"
      provides: "Country code validation (already exists from Phase 1)"
      contains: "VALID_COUNTRY_CODES"
  key_links:
    - from: "src/components/verpakking/VerpakkingsClient.tsx"
      to: "/api/verpakking/engine/calculate"
      via: "fetch POST with countryCode in body"
      pattern: "countryCode.*order\\.deliverycountry"
    - from: "src/components/verpakking/VerpakkingsClient.tsx"
      to: "EngineAdvice.cost_data_available"
      via: "conditional rendering of cost section vs warning"
      pattern: "cost_data_available"
---

<objective>
Surface cost breakdown data in the packing UI and verify the country code API contract works end-to-end.

Purpose: Medewerkers zien bij het inpakken per geadviseerde doos de kostenopbouw (doos + transport + totaal) zodat ze begrijpen waarom de engine een bepaalde doos adviseert. Wanneer kostdata niet beschikbaar is, zien ze een duidelijke waarschuwing.

Output: Updated VerpakkingsClient.tsx with cost display in advice banner, box selection modal, and cost-unavailable warning. Verified API-01 contract (already implemented in Phase 1).
</objective>

<execution_context>
@/Users/kennylipman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kennylipman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-api-ui-integration/03-RESEARCH.md

# Key source files
@src/components/verpakking/VerpakkingsClient.tsx
@src/app/api/verpakking/engine/calculate/route.ts
@src/lib/engine/packagingEngine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cost display to VerpakkingsClient advice UI</name>
  <files>src/components/verpakking/VerpakkingsClient.tsx</files>
  <action>
Update the VerpakkingsClient component to display cost breakdown from the engine response. All changes are in this single file. The engine already returns cost data — the frontend just doesn't consume it yet.

**Step 1: Update TypeScript interfaces (around line 55-71)**

Add cost fields to `EngineAdviceBox` interface:
```typescript
interface EngineAdviceBox {
  packaging_id: string
  packaging_name: string
  idpackaging: number
  products: { productcode: string; shipping_unit_name: string; quantity: number }[]
  box_cost?: number        // NEW
  transport_cost?: number  // NEW
  total_cost?: number      // NEW
}
```

Add `cost_data_available` to `EngineAdvice` interface:
```typescript
interface EngineAdvice {
  id: string
  order_id: number
  confidence: 'full_match' | 'partial_match' | 'no_match'
  advice_boxes: EngineAdviceBox[]
  shipping_units_detected: { shipping_unit_id: string; shipping_unit_name: string; quantity: number }[]
  unclassified_products: string[]
  tags_written: string[]
  weight_exceeded?: boolean
  cost_data_available?: boolean  // NEW
}
```

**Step 2: Add formatCost helper (after the interfaces, before the component)**

```typescript
function formatCost(value: number | undefined): string {
  if (value === undefined) return '-'
  return `\u20AC${value.toFixed(2)}`
}
```
(Use the euro sign character directly, not an HTML entity.)

**Step 3: Add total cost summary to collapsed advice banner (around line 1217-1218)**

After the existing `full_match` text `Advies: {boxes.join(' + ')}`, add a total cost summary:
```tsx
{engineAdvice.confidence === 'full_match' && (
  <>
    Advies: {engineAdvice.advice_boxes.map((b) => b.packaging_name).join(' + ')}
    {engineAdvice.cost_data_available !== false && engineAdvice.advice_boxes.some(b => b.total_cost !== undefined) && (
      <span className="ml-1 font-medium">
        ({formatCost(engineAdvice.advice_boxes.reduce((sum, b) => sum + (b.total_cost ?? 0), 0))} totaal)
      </span>
    )}
  </>
)}
```
Do the same for `partial_match` (line 1220-1222): add total cost after the box names.

**Step 4: Add per-box cost breakdown to expanded advice details (inside adviceDetailsExpanded block, around line 1258, AFTER the unclassified_products section)**

Add a new section showing cost per box when cost data is available:
```tsx
{engineAdvice.cost_data_available !== false && engineAdvice.advice_boxes.some(b => b.total_cost !== undefined) && (
  <div>
    <span className="font-medium">Kosten per doos:</span>
    <div className="mt-0.5 space-y-0.5">
      {engineAdvice.advice_boxes.map((box, idx) => (
        box.total_cost !== undefined ? (
          <div key={idx} className="flex items-center justify-between">
            <span>{box.packaging_name}</span>
            <span className="tabular-nums">
              {formatCost(box.box_cost)} doos + {formatCost(box.transport_cost)} transport = <strong>{formatCost(box.total_cost)}</strong>
            </span>
          </div>
        ) : null
      ))}
    </div>
  </div>
)}
```

**Step 5: Add cost-unavailable warning to expanded details (after the cost breakdown section, before closing of adviceDetailsExpanded)**

```tsx
{engineAdvice.cost_data_available === false && (
  <div className="flex items-center gap-1.5 text-amber-700">
    <AlertTriangle className="w-3.5 h-3.5 flex-shrink-0" />
    <span>Advies op basis van specificiteit — kostdata niet beschikbaar</span>
  </div>
)}
```
Note: `AlertTriangle` is already imported from lucide-react.

**Step 6: Add cost display to box selection buttons in add-box modal (around line 1923-1928)**

Inside the `engineAdvice.advice_boxes.map` callback in the box selection modal, after the products line, add cost info:
```tsx
<div className="flex-1 min-w-0">
  <p className="font-medium text-sm">{adviceBox.packaging_name}</p>
  <p className="text-xs text-muted-foreground">
    {adviceBox.products.map((p) => `${p.quantity}x ${p.shipping_unit_name}`).join(', ')}
  </p>
  {adviceBox.total_cost !== undefined && (
    <p className="text-xs text-emerald-700 font-medium mt-0.5">
      {formatCost(adviceBox.box_cost)} doos + {formatCost(adviceBox.transport_cost)} transport = {formatCost(adviceBox.total_cost)}
    </p>
  )}
</div>
```

**IMPORTANT anti-patterns to avoid:**
- Do NOT display EUR 0.00 when cost is `undefined` — the engine uses `|| undefined` to convert 0 from non-enriched to undefined (Phase 2 decision). Always check `!== undefined`.
- Do NOT gate the ENTIRE advice banner on cost data — the advice is still useful without costs (specificity-based). Only gate the COST DISPLAY sections.
- Do NOT add cost fields to BoxCard or session boxes — costs are on the engine advice only, not on packing session boxes.
- Do NOT make countryCode required in the API route — keep it optional per Phase 1 decision.
  </action>
  <verify>
    <automated>cd /Users/kennylipman/everyplants-batchmaker && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Start dev server, navigate to verpakkingsmodule, open a batch with a picklist. Verify: (1) advice banner shows total cost in parentheses, (2) expanded details show per-box cost breakdown, (3) box selection buttons show cost per box, (4) when cost data is unavailable, amber warning appears instead of cost section</manual>
  </verify>
  <done>EngineAdviceBox and EngineAdvice interfaces include cost fields. Collapsed banner shows total cost summary. Expanded details show per-box cost breakdown (doos + transport = totaal). Box selection modal shows cost per advised box. Cost-unavailable warning displays when cost_data_available is false. TypeScript compiles without errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify cost display and API country code end-to-end</name>
  <files>src/components/verpakking/VerpakkingsClient.tsx</files>
  <action>
Human verification of the complete cost display integration and API-01 country code contract. No code changes in this task — purely visual and functional verification of Task 1 output plus Phase 1 API work.

Verify these items:
1. **API-01**: countryCode validation in POST /api/verpakking/engine/calculate (implemented in Phase 1)
2. **API-01**: VerpakkingsClient sends order.deliverycountry automatically (implemented in Phase 1)
3. **UI-01**: Per-box cost breakdown (dooskosten + transportkosten = totaalkosten) in advice banner
4. **UI-01**: Total cost summary in collapsed advice banner
5. **UI-01**: Cost per box in box selection modal buttons
6. **UI-01**: Amber warning when cost data is unavailable

Steps:
1. Start dev server: `npm run dev`
2. Navigate to `/verpakkingsmodule`
3. Select a worker, claim a batch, open a picklist
4. **Check collapsed banner**: Should show "Advies: [box name] (EUR X.XX totaal)" for full_match
5. **Check expanded details**: Click the banner to expand. Should show "Kosten per doos:" with per-box breakdown
6. **Check box selection**: Click "Doos toevoegen". Engine advies section should show cost per advised box
7. **Check country threading**: In browser devtools Network tab, find the POST to `/api/verpakking/engine/calculate`. Verify request body includes `countryCode` field
8. **Check cost-unavailable state**: If testing with a country/box combo without cost data, verify amber warning appears
  </action>
  <verify>
    <automated>cd /Users/kennylipman/everyplants-batchmaker && npx tsc --noEmit --pretty 2>&1 | head -5</automated>
    <manual>Visual verification of all 6 items listed above in the running application</manual>
  </verify>
  <done>User has confirmed: (1) cost breakdown is visible in advice banner, (2) total cost shows in collapsed banner, (3) box selection shows per-box cost, (4) warning appears when cost data unavailable, (5) countryCode is sent in API request, (6) API validates country codes correctly.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit` returns no errors
2. Cost fields visible in advice banner (collapsed: total, expanded: per-box breakdown)
3. Cost fields visible in box selection modal
4. Cost-unavailable warning appears when `cost_data_available === false`
5. API route accepts and validates countryCode (already working from Phase 1)
6. VerpakkingsClient sends order.deliverycountry to engine API (already working from Phase 1)
</verification>

<success_criteria>
- EngineAdviceBox interface includes box_cost, transport_cost, total_cost optional fields
- EngineAdvice interface includes cost_data_available optional boolean
- Collapsed advice banner shows aggregated total cost in parentheses
- Expanded advice details show per-box cost breakdown (doos + transport = totaal)
- Box selection buttons show cost per advised box in emerald text
- Amber warning displays when cost_data_available is false
- countryCode is sent automatically from VerpakkingsClient (Phase 1 verification)
- API validates countryCode against VALID_COUNTRY_CODES (Phase 1 verification)
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-ui-integration/03-01-SUMMARY.md`
</output>
