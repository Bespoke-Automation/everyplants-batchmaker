---
phase: 02-cost-primary-ranking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/engine/packagingEngine.ts]
autonomous: true
requirements: [ENG-01]
gap_closure: true

must_haves:
  truths:
    - "All inner matchCompartments calls in solveMultiBox produce enriched matches before rankPackagings"
    - "The mixable-products fallback path (allMatches.length === 0) enriches matches with cost data before ranking"
  artifacts:
    - path: "src/lib/engine/packagingEngine.ts"
      provides: "enrichWithCosts call on mixable fallback path"
      contains: "enrichWithCosts(await matchCompartments(mixableRemaining), costMap)"
  key_links:
    - from: "solveMultiBox mixable fallback (line ~703)"
      to: "enrichWithCosts()"
      via: "wrapping matchCompartments result before rankPackagings"
      pattern: "enrichWithCosts\\(await matchCompartments\\(mixableRemaining\\)"
---

<objective>
Fix the one missing enrichWithCosts() call in solveMultiBox's mixable-products fallback path.

Purpose: Verification found that when allMatches.length === 0, the mixable fallback calls matchCompartments(mixableRemaining) but passes the result directly to rankPackagings() without cost enrichment. This violates the truth that all inner matchCompartments calls produce enriched matches before ranking. While this is a low-impact edge case (no outer matches means the greedy solver also likely finds nothing), it must be fixed for correctness.

Output: Patched packagingEngine.ts with all 3 inner matchCompartments call sites correctly enriched.
</objective>

<execution_context>
@/Users/kennylipman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kennylipman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cost-primary-ranking/02-01-SUMMARY.md
@src/lib/engine/packagingEngine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enrichWithCosts to mixable fallback path in solveMultiBox</name>
  <files>src/lib/engine/packagingEngine.ts</files>
  <action>
In solveMultiBox(), find the mixable-products fallback around lines 699-705. The current code is:

```typescript
const mixableMatches = allMatches.length > 0
  ? recalculateMatchesForRemaining(allMatches, mixableRemaining)
  : await matchCompartments(mixableRemaining)
```

Change the fallback branch to wrap the matchCompartments result with enrichWithCosts:

```typescript
const mixableMatches = allMatches.length > 0
  ? recalculateMatchesForRemaining(allMatches, mixableRemaining)
  : enrichWithCosts(await matchCompartments(mixableRemaining), costMap)
```

This ensures the fallback path (when allMatches is empty) enriches matches with cost data before they reach rankPackagings() on the next line, consistent with the other 2 inner matchCompartments call sites in solveMultiBox (non-mixable singleUnit ~line 668 and greedy pool ~line 737).

No other changes needed. enrichWithCosts is already in scope (defined earlier in the file), and costMap is already a parameter of solveMultiBox.
  </action>
  <verify>
    <automated>cd /Users/kennylipman/everyplants-batchmaker && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify all 3 inner matchCompartments sites in solveMultiBox are wrapped with enrichWithCosts: grep for "enrichWithCosts" in the solveMultiBox function body — should find 3 occurrences</manual>
  </verify>
  <done>All 3 inner matchCompartments call sites in solveMultiBox pass through enrichWithCosts before rankPackagings. TypeScript compiles without errors. The pattern `enrichWithCosts(await matchCompartments(` appears in the mixable fallback path.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — no type errors introduced
2. grep for `enrichWithCosts` inside solveMultiBox function finds exactly 3 calls (non-mixable singleUnit, mixable fallback, greedy pool)
3. The line `enrichWithCosts(await matchCompartments(mixableRemaining), costMap)` exists in the mixable fallback branch
</verification>

<success_criteria>
- TypeScript compiles cleanly
- All 3 inner matchCompartments calls in solveMultiBox are enriched before ranking
- No other code changes beyond the single-line fix
</success_criteria>

<output>
After completion, create `.planning/phases/02-cost-primary-ranking/02-02-SUMMARY.md`
</output>
