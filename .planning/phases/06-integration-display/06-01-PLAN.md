---
phase: 06-integration-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/engine/packagingEngine.ts
  - src/types/verpakking.ts
  - src/components/verpakking/VerpakkingsClient.tsx
autonomous: false
requirements:
  - DISPLAY-01
  - DISPLAY-02
  - DISPLAY-03
  - DEGRAD-02

must_haves:
  truths:
    - "Medewerker ziet per geadviseerde doos: dooskosten, pick/pack kosten, transportkosten en totaalkosten"
    - "Bij multi-box advies toont het systeem per-doos kosten EN totaalkosten van de complete oplossing"
    - "Medewerker ziet bestemmingsland en geselecteerde carrier bij het kostenadvies"
    - "Wanneer advies op specificiteit is gebaseerd (geen kostdata), toont de UI een amber waarschuwing die dit duidelijk aangeeft"
  artifacts:
    - path: "src/types/verpakking.ts"
      provides: "AdviceBox with box_pick_cost, box_pack_cost, carrier_code fields"
      contains: "box_pick_cost"
    - path: "src/lib/engine/packagingEngine.ts"
      provides: "Engine threads pick/pack costs and carrier_code to AdviceBox"
      contains: "box_pick_cost"
    - path: "src/components/verpakking/VerpakkingsClient.tsx"
      provides: "Expanded cost breakdown display with carrier and country"
      contains: "pick/pack"
  key_links:
    - from: "src/lib/engine/packagingEngine.ts"
      to: "src/types/verpakking.ts"
      via: "enrichWithCosts and refineBoxCostWithWeight set new AdviceBox fields"
      pattern: "box_pick_cost.*entry\\.boxPickCost"
    - from: "src/components/verpakking/VerpakkingsClient.tsx"
      to: "EngineAdviceBox type"
      via: "Reads box_pick_cost, box_pack_cost, carrier_code from advice response"
      pattern: "box_pick_cost|carrier_code"
---

<objective>
Update the AdviceBox type to carry pick/pack costs and carrier code from the engine, then expand the VerpakkingsClient UI to show the full cost breakdown (doos + pick/pack + transport = totaal) with carrier and destination country display.

Purpose: Phase 4+5 made the engine produce correct cost-optimized advice with all cost components (material, pick, pack, transport) and weight brackets. Phase 6 exposes these details to the medewerker so they see exactly why a box is recommended and what it costs.

Output: Updated AdviceBox type, engine threading, and VerpakkingsClient with expanded cost display.
</objective>

<execution_context>
@/Users/kennylipman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kennylipman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-api-ui-integration/03-01-SUMMARY.md
@src/types/verpakking.ts
@src/lib/engine/packagingEngine.ts
@src/lib/engine/costProvider.ts
@src/components/verpakking/VerpakkingsClient.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AdviceBox type and thread pick/pack costs + carrier_code through engine</name>
  <files>src/types/verpakking.ts, src/lib/engine/packagingEngine.ts</files>
  <action>
**1. Extend AdviceBox in `src/types/verpakking.ts`:**

Add new optional fields to the existing AdviceBox interface:
```typescript
export interface AdviceBox {
  packaging_id: string
  packaging_name: string
  idpackaging: number
  products: { productcode: string; shipping_unit_name: string; quantity: number }[]
  box_cost?: number           // box material cost (existing)
  box_pick_cost?: number      // pick cost per box type (NEW)
  box_pack_cost?: number      // pack cost per box type (NEW)
  transport_cost?: number     // transport cost (existing)
  total_cost?: number         // total = material + pick + pack + transport (existing)
  carrier_code?: string       // selected carrier e.g. "PostNL", "DPD" (NEW)
  weight_grams?: number       // total product weight in box (may already exist from Phase 4 plan 3)
  weight_bracket?: string | null  // selected weight bracket (may already exist from Phase 4 plan 3)
}
```

Keep all new fields optional (?) for backward compatibility with existing stored advice in the database.

**2. Thread new fields through `enrichWithCosts` in `packagingEngine.ts`:**

Find the `enrichWithCosts` function. Where it currently sets `box_cost`, `transport_cost`, and `total_cost` from a CostEntry, also set:
```typescript
box_pick_cost: entry.boxPickCost,
box_pack_cost: entry.boxPackCost,
carrier_code: entry.carrier,  // CostEntry.carrier contains the carrier_code string
```

The CostEntry type (from Phase 4 plan 2) has `boxPickCost: number`, `boxPackCost: number`, and `carrier: string`. Map these directly.

**3. Thread new fields through `refineBoxCostWithWeight` in `packagingEngine.ts`:**

Find the `refineBoxCostWithWeight` function (from Phase 4 plan 3). Where it currently sets `box_cost`, `transport_cost`, `total_cost`, `weight_grams`, and `weight_bracket`, also set:
```typescript
box_pick_cost: entry.boxPickCost,
box_pack_cost: entry.boxPackCost,
carrier_code: entry.carrier,
```

**4. Thread new fields through the fallback box creation paths:**

Search for all places in packagingEngine.ts where AdviceBox objects are constructed (grep for `packaging_name:` or `packaging_id:`). In each creation site, ensure `box_pick_cost`, `box_pack_cost`, and `carrier_code` are set if cost data is available, or left as undefined if not.

Key creation sites to check:
- The `solveMultiBox` function (non-mixable product boxes and mixable boxes)
- The fallback path in `calculateAdvice` (tag-based fallback)
- Any direct AdviceBox construction

For fallback paths that don't use cost data: leave the new fields undefined (they're optional).

**5. Verify no type errors:**

Run `npx tsc --noEmit` to confirm the extended AdviceBox type and all creation sites compile cleanly. The new fields are optional, so existing creation sites that don't set them should compile fine.
  </action>
  <verify>
    <automated>cd /Users/kennylipman/everyplants-batchmaker && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify AdviceBox has box_pick_cost, box_pack_cost, carrier_code. Verify enrichWithCosts and refineBoxCostWithWeight set these fields from CostEntry.</manual>
  </verify>
  <done>AdviceBox type has box_pick_cost, box_pack_cost, carrier_code fields. enrichWithCosts and refineBoxCostWithWeight thread these from CostEntry. All AdviceBox creation sites compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update VerpakkingsClient cost display with expanded breakdown, carrier, and country</name>
  <files>src/components/verpakking/VerpakkingsClient.tsx</files>
  <action>
**1. Update the `EngineAdviceBox` interface** (local type in VerpakkingsClient.tsx) to include the new fields:
```typescript
interface EngineAdviceBox {
  packaging_id: string
  packaging_name: string
  idpackaging: number
  products: { productcode: string; shipping_unit_name: string; quantity: number }[]
  box_cost?: number
  box_pick_cost?: number      // NEW
  box_pack_cost?: number      // NEW
  transport_cost?: number
  total_cost?: number
  carrier_code?: string       // NEW
  weight_grams?: number       // NEW
  weight_bracket?: string     // NEW
}
```

**2. Expand the cost breakdown in the expanded advice details section** (the `adviceDetailsExpanded` block around line 1298-1314).

Replace the current cost display:
```
{formatCost(box.box_cost)} doos + {formatCost(box.transport_cost)} transport = {formatCost(box.total_cost)}
```

With an expanded breakdown that shows pick/pack separately:
```tsx
<div key={idx} className="flex flex-col gap-0.5">
  <div className="flex items-center justify-between">
    <span className="font-medium">{box.packaging_name}</span>
    <span className="tabular-nums font-semibold">{formatCost(box.total_cost)}</span>
  </div>
  <div className="flex items-center justify-between text-[11px] opacity-75">
    <span>
      {formatCost(box.box_cost)} doos
      {(box.box_pick_cost !== undefined || box.box_pack_cost !== undefined) && (
        <> + {formatCost((box.box_pick_cost ?? 0) + (box.box_pack_cost ?? 0))} pick/pack</>
      )}
      {' '}+ {formatCost(box.transport_cost)} transport
    </span>
    {box.carrier_code && (
      <span className="ml-2">{box.carrier_code}{box.weight_bracket ? ` (${box.weight_bracket})` : ''}</span>
    )}
  </div>
</div>
```

This shows:
- Line 1: box name + total cost (bold)
- Line 2: breakdown (doos + pick/pack + transport) + carrier + weight bracket

**3. Add destination country display above the cost breakdown.**

The VerpakkingsClient already has access to the order object (the `order` variable of type `PicqerOrder`). The country is at `order.deliveryaddress?.deliveryCountry` or similar. Find how order country is accessed (it's already threaded to the engine API call -- grep for `deliverycountry` or `deliveryaddress`).

Add a line showing the destination country above the cost breakdown section:
```tsx
{order?.deliveryaddress?.country && (
  <div className="flex items-center gap-1.5">
    <MapPin className="w-3 h-3 flex-shrink-0" />
    <span className="font-medium">Bestemming:</span>
    <span>{getCountryName(order.deliveryaddress.country)}</span>
  </div>
)}
```

Add the `MapPin` icon import from lucide-react (check if already imported).

Add a simple helper function:
```typescript
function getCountryName(code: string): string {
  const countries: Record<string, string> = {
    NL: 'Nederland', BE: 'Belgie', DE: 'Duitsland', FR: 'Frankrijk',
    AT: 'Oostenrijk', LU: 'Luxemburg', SE: 'Zweden', IT: 'Italie', ES: 'Spanje',
  }
  return countries[code?.toUpperCase()] ?? code
}
```

**4. Update the multi-box total cost display** (DISPLAY-02).

The collapsed banner already shows total cost as sum of all boxes. Enhance the expanded details to also show a clear total line when there are multiple boxes:
```tsx
{engineAdvice.advice_boxes.length > 1 && engineAdvice.advice_boxes.some(b => b.total_cost !== undefined) && (
  <div className="flex items-center justify-between font-semibold border-t border-current/10 pt-1 mt-1">
    <span>Totaal ({engineAdvice.advice_boxes.length} dozen)</span>
    <span className="tabular-nums">
      {formatCost(engineAdvice.advice_boxes.reduce((sum, b) => sum + (b.total_cost ?? 0), 0))}
    </span>
  </div>
)}
```

Place this AFTER the per-box cost breakdown in the expanded details section.

**5. Update the amber degradation warning** (DEGRAD-02).

The current warning says: "Advies op basis van specificiteit -- kostdata niet beschikbaar"

Make it clearer by updating to:
```tsx
{engineAdvice.cost_data_available === false && (
  <div className="flex items-center gap-1.5 text-amber-700 bg-amber-50 rounded px-2 py-1.5">
    <AlertTriangle className="w-3.5 h-3.5 flex-shrink-0" />
    <span>
      <strong>Specificiteit-advies</strong> -- Kostdata is niet beschikbaar.
      Advies is gebaseerd op doosgrootte en specificiteit, niet op kosten.
    </span>
  </div>
)}
```

**6. Update the box selection modal** (around line 1974-1977).

The box selection buttons currently show: `{formatCost(box.box_cost)} doos + {formatCost(box.transport_cost)} transport = {formatCost(box.total_cost)}`

Update to include carrier info while keeping it compact:
```tsx
{adviceBox.total_cost !== undefined && (
  <p className="text-xs text-emerald-700 font-medium mt-0.5">
    {formatCost(adviceBox.total_cost)} totaal
    {adviceBox.carrier_code && <span className="opacity-75"> via {adviceBox.carrier_code}</span>}
  </p>
)}
```

Keep the box selection buttons compact -- the full breakdown is in the expanded details. The button just shows total + carrier for quick selection.

**7. Verify no rendering issues:**

Ensure all new fields are gated with optional checks (they may be undefined for old/cached advice). Every access to `box_pick_cost`, `box_pack_cost`, `carrier_code` must handle undefined gracefully.
  </action>
  <verify>
    <automated>cd /Users/kennylipman/everyplants-batchmaker && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Open /verpakkingsmodule, start a packing session, and verify: (1) expanded advice shows doos + pick/pack + transport per box, (2) carrier and weight bracket shown, (3) multi-box total shown, (4) destination country shown, (5) amber warning appears when cost_data_available is false.</manual>
  </verify>
  <done>VerpakkingsClient shows expanded cost breakdown per box (doos + pick/pack + transport = totaal), carrier code and weight bracket, destination country, multi-box total cost, and improved amber degradation warning. All fields handle undefined gracefully for backward compatibility.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify cost display in packing session</name>
  <files>src/components/verpakking/VerpakkingsClient.tsx</files>
  <action>
Human verification of the cost display changes in the packing screen. Start the dev server and open /verpakkingsmodule to verify the visual presentation of cost data.

Verify these areas:
1. Expanded advice details: per-box cost breakdown shows doos + pick/pack + transport = totaalkosten
2. Carrier code and weight bracket shown per box
3. Destination country shown (e.g., "Bestemming: Duitsland")
4. Multi-box total cost line shown below individual boxes
5. Box selection modal buttons show total cost + carrier
6. Amber warning when cost_data_available is false

Note: If Phase 4+5 haven't been deployed yet, the new fields (pick/pack, carrier) will show as undefined/hidden. That's expected -- the display gracefully handles missing fields. The test confirms the UI renders without errors and will display the data correctly once the engine produces it.
  </action>
  <verify>
    <automated>cd /Users/kennylipman/everyplants-batchmaker && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Visual verification of cost display in packing session UI</manual>
  </verify>
  <done>User has visually confirmed the cost display renders correctly in the packing session, showing per-box breakdown, carrier, country, and degradation warning.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. AdviceBox type has box_pick_cost, box_pack_cost, carrier_code fields
3. Engine enrichWithCosts and refineBoxCostWithWeight thread new fields from CostEntry
4. VerpakkingsClient expanded details show: doos + pick/pack + transport per box
5. Multi-box total cost shown when multiple boxes
6. Destination country displayed from order.deliveryaddress
7. Carrier code and weight bracket shown per box
8. Amber degradation warning updated with clearer message
9. All new field accesses handle undefined gracefully
</verification>

<success_criteria>
- Per-box cost breakdown shows dooskosten, pick/pack kosten, transportkosten en totaalkosten (DISPLAY-01)
- Multi-box advice shows per-doos kosten AND totaalkosten van complete oplossing (DISPLAY-02)
- Bestemmingsland en carrier worden getoond bij kostenadvies (DISPLAY-03)
- Amber waarschuwing bij specificiteit-advies is duidelijk en prominent (DEGRAD-02)
- TypeScript compiles cleanly
- Backward compatible: old advice data without new fields renders without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-display/06-01-SUMMARY.md`
</output>
