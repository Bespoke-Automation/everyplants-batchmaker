---
phase: 04-cost-data-layer-v2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/verpakking.ts
  - src/lib/supabase/localPackagings.ts
  - src/hooks/useLocalPackagings.ts
  - src/app/api/verpakking/packagings/update/route.ts
  - src/components/verpakking/PackagingList.tsx
autonomous: true
requirements:
  - SKU-01
  - SKU-02

must_haves:
  truths:
    - "Every active packaging has a facturatie_box_sku column in the database"
    - "The 22 known mappings (6 mismatches + 16 same-as-barcode) are seeded correctly"
    - "The 3 batchmaker-only packagings have NULL facturatie_box_sku"
    - "Admin can view and edit the facturatie_box_sku field in the packaging settings"
  artifacts:
    - path: "src/types/verpakking.ts"
      provides: "LocalPackaging type with facturatieBoxSku field"
      contains: "facturatieBoxSku"
    - path: "src/lib/supabase/localPackagings.ts"
      provides: "LocalPackagingRow with facturatie_box_sku column"
      contains: "facturatie_box_sku"
    - path: "src/components/verpakking/PackagingList.tsx"
      provides: "Admin UI field for facturatie_box_sku editing"
      contains: "facturatieBoxSku"
  key_links:
    - from: "src/components/verpakking/PackagingList.tsx"
      to: "src/hooks/useLocalPackagings.ts"
      via: "updatePackaging call with facturatie_box_sku"
      pattern: "facturatie_box_sku|facturatieBoxSku"
    - from: "src/app/api/verpakking/packagings/update/route.ts"
      to: "src/lib/supabase/localPackagings.ts"
      via: "updateLocalPackaging with facturatie_box_sku in ENGINE_FIELDS"
      pattern: "facturatie_box_sku"
---

<objective>
Add the `facturatie_box_sku` column to the packagings table, seed all 22 known mappings, and add admin UI for managing the SKU mapping.

Purpose: This is the foundation for the v2 cost data pipeline. The `facturatie_box_sku` column is the join key between batchmaker packagings and the facturatie `published_box_costs` table. Without correct mappings, the costProvider cannot look up costs.

Output: Database column with seed data, updated types, admin UI for managing mappings.
</objective>

<execution_context>
@/Users/kennylipman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kennylipman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/verpakking.ts
@src/lib/supabase/localPackagings.ts
@src/hooks/useLocalPackagings.ts
@src/app/api/verpakking/packagings/update/route.ts
@src/components/verpakking/PackagingList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add facturatie_box_sku column and seed 22 mappings</name>
  <files>src/types/verpakking.ts, src/lib/supabase/localPackagings.ts, src/hooks/useLocalPackagings.ts</files>
  <action>
1. Run a Supabase migration to add `facturatie_box_sku TEXT` column to `batchmaker.packagings` table. Use `mcp__supabase__apply_migration` with name `add_facturatie_box_sku_to_packagings`. The migration should:
   - ADD COLUMN `facturatie_box_sku TEXT DEFAULT NULL`
   - ADD a COMMENT on the column: 'Join key to facturatie published_box_costs.box_sku'
   - Seed the 22 mappings using UPDATE statements. The 6 mismatches:
     - barcode='55_922' -> facturatie_box_sku='55_950'
     - barcode='55_896' -> facturatie_box_sku='55_922'
     - barcode='55_897' -> facturatie_box_sku='55_923'
     - barcode='55_1180' -> facturatie_box_sku='55_926-1'
     - barcode='55_1178' -> facturatie_box_sku='55_1'
     - barcode='55_900' -> facturatie_box_sku='55_917'
   - For all OTHER active packagings where barcode IS NOT NULL and barcode NOT IN ('55_890','55_891','55_1053','55_922','55_896','55_897','55_1180','55_1178','55_900'), set facturatie_box_sku = barcode (16 same-as-barcode)
   - Explicitly set facturatie_box_sku = NULL for batchmaker-only: barcode IN ('55_890','55_891','55_1053') (these have no facturatie equivalent)

2. Update `LocalPackagingRow` in `src/lib/supabase/localPackagings.ts`:
   - Add `facturatie_box_sku: string | null` field
   - Update `updateLocalPackaging` type to accept `facturatie_box_sku` in its Partial<Pick<...>> union

3. Update `LocalPackaging` interface in `src/types/verpakking.ts`:
   - Add `facturatieBoxSku: string | null` field

4. Update `useLocalPackagings.ts`:
   - Add `facturatie_box_sku` to `ApiLocalPackaging` interface
   - Map `facturatie_box_sku` to `facturatieBoxSku` in `transformPackaging()`
  </action>
  <verify>
    <automated>cd /Users/kennylipman/everyplants-batchmaker && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Check that the migration was applied and the seed data is correct by querying: SELECT barcode, facturatie_box_sku FROM batchmaker.packagings WHERE facturatie_box_sku IS NOT NULL ORDER BY barcode</manual>
  </verify>
  <done>The packagings table has a facturatie_box_sku column. The 6 mismatch mappings are seeded with correct values. The 16 same-as-barcode mappings have facturatie_box_sku = barcode. The 3 batchmaker-only have NULL. Types are updated across the stack.</done>
</task>

<task type="auto">
  <name>Task 2: Add facturatie_box_sku to admin UI and update API</name>
  <files>src/app/api/verpakking/packagings/update/route.ts, src/components/verpakking/PackagingList.tsx</files>
  <action>
1. Update the packagings update API route (`src/app/api/verpakking/packagings/update/route.ts`):
   - Add `'facturatie_box_sku'` to the `ENGINE_FIELDS` array (this field is engine-only, not synced to Picqer)

2. Update `PackagingList.tsx` to show and edit `facturatie_box_sku`:
   - Add `facturatieBoxSku: string` to `PackagingFormData` interface (empty string = null)
   - Add it to `emptyFormData` with default `''`
   - In the form, add a text input field for "Facturatie Box SKU" in the engine fields section (near barcode/materialCost area). Label: "Facturatie SKU" with placeholder "bijv. 55_949". Add a small helper text below: "Join key naar facturatie kosten. Laat leeg als geen facturatie equivalent."
   - In the edit handler that populates `formData` from existing packaging, set `facturatieBoxSku: pkg.facturatieBoxSku || ''`
   - In the save handler, include `facturatie_box_sku: formData.facturatieBoxSku || null` in the update/create payload
   - In the packaging list/table view, show the facturatie_box_sku value as a small badge or secondary text next to the barcode, only when it differs from barcode (to highlight mismatches). Use a subtle amber/yellow badge for mismatches, gray for same-as-barcode. Format: show `SKU: {value}` or `Geen SKU` for null.
  </action>
  <verify>
    <automated>cd /Users/kennylipman/everyplants-batchmaker && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Visit /verpakkingsmodule/instellingen, open a packaging for editing, verify the Facturatie SKU field is visible and editable. Save a change and verify it persists.</manual>
  </verify>
  <done>Admin can view and edit the facturatie_box_sku mapping for any packaging. Mismatches are visually highlighted in the list. The API route accepts and persists facturatie_box_sku updates.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Database has facturatie_box_sku column on packagings table
3. Seed data is correct: 6 mismatches have different SKU, 16 have same-as-barcode, 3 are NULL
4. Admin UI shows the field and allows editing
</verification>

<success_criteria>
- All 22 known packagings have correct facturatie_box_sku values
- Admin can create/edit the mapping for new packagings
- TypeScript types are consistent across the full stack (verpakking.ts -> localPackagings.ts -> hook -> component)
</success_criteria>

<output>
After completion, create `.planning/phases/04-cost-data-layer-v2/04-01-SUMMARY.md`
</output>
